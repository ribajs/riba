!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.tinybind=e()}(this,function(){"use strict";var s=["prefix","templateDelimiters","rootInterface","preloadData","handler"],o=["binders","formatters","components","adapters"],n=0,r=1,a=/^'.*'$|^".*"$/;function p(t){var e=n,i=t;return a.test(t)?i=t.slice(1,-1):"true"===t?i=!0:"false"===t?i=!1:"null"===t?i=null:"undefined"===t?i=void 0:isNaN(t)?!function(t){try{var e=JSON.parse(t);return e instanceof Array||e instanceof Object}catch(t){return!1}}(t)?e=r:i=JSON.parse(t):i=Number(t),{type:e,value:i}}function c(t,e){for(var i,n=t.length,r=0,s=0,o=e[0],a=e[1];s<n;){if((r=t.indexOf(o,s))<0){i&&i.push({type:0,value:t.slice(s)});break}if(i=i||[],0<r&&s<r&&i.push({type:0,value:t.slice(s,r)}),s=r+o.length,(r=t.indexOf(a,s))<0){var h=t.slice(s-a.length),c=i[i.length-1];c&&0===c.type?c.value+=h:i.push({type:0,value:h});break}var u=t.slice(s,r).trim();i.push({type:1,value:u}),s=r+a.length}return i}var h,u,i,b={binders:{},components:{},formatters:{},adapters:{},_prefix:"rv",_fullPrefix:"rv-",get prefix(){return this._prefix},set prefix(t){this._prefix=t,this._fullPrefix=t+"-"},parseTemplate:c,parseType:p,templateDelimiters:["{","}"],rootInterface:".",preloadData:!0,handler:function(t,e,i){this.call(t,e,i.view.models)},fallbackBinder:function(t,e){null!=e?t.setAttribute(this.type,e):t.removeAttribute(this.type)},configure:function(t){var n=this;t&&Object.keys(t).forEach(function(e){var i=t[e];-1<o.indexOf(e)?Object.keys(i).forEach(function(t){n[e][t]=i[t]}):n[e]=i})}};function l(t){return"object"==typeof t&&null!==t}function f(t,e,i){this.keypath=e,this.callback=i,this.objectPath=[],this.parse(),this.obj=this.getRootObject(t),l(this.target=this.realize())&&this.set(!0,this.key,this.target,this.callback)}f.updateOptions=function(t){h=t.adapters,u=Object.keys(h),i=t.rootInterface},f.tokenize=function(t,e){var i,n,r=[],s={i:e,path:""};for(i=0;i<t.length;i++)n=t.charAt(i),~u.indexOf(n)?(r.push(s),s={i:n,path:""}):s.path+=n;return r.push(s),r},f.prototype.parse=function(){var t,e;u.length||function(t){throw new Error("[Observer] "+t)}("Must define at least one adapter interface."),~u.indexOf(this.keypath[0])?(e=this.keypath[0],t=this.keypath.substr(1)):(e=i,t=this.keypath),this.tokens=f.tokenize(t,e),this.key=this.tokens.pop()},f.prototype.realize=function(){for(var t,e,i=this.obj,n=-1,r=0;r<this.tokens.length;r++)e=this.tokens[r],l(i)?(void 0!==this.objectPath[r]?i!==(t=this.objectPath[r])&&(this.set(!1,e,t,this),this.set(!0,e,i,this),this.objectPath[r]=i):(this.set(!0,e,i,this),this.objectPath[r]=i),i=this.get(e,i)):(-1===n&&(n=r),(t=this.objectPath[r])&&this.set(!1,e,t,this));return-1!==n&&this.objectPath.splice(n),i},f.prototype.sync=function(){var t,e,i;(t=this.realize())!==this.target?(l(this.target)&&this.set(!1,this.key,this.target,this.callback),l(t)&&this.set(!0,this.key,t,this.callback),e=this.value(),this.target=t,((i=this.value())!==e||i instanceof Function)&&this.callback.sync()):t instanceof Array&&this.callback.sync()},f.prototype.value=function(){if(l(this.target))return this.get(this.key,this.target)},f.prototype.setValue=function(t){l(this.target)&&h[this.key.i].set(this.target,this.key.path,t)},f.prototype.get=function(t,e){return h[t.i].get(e,t.path)},f.prototype.set=function(t,e,i,n){var r=t?"observe":"unobserve";h[e.i][r](i,e.path,n)},f.prototype.unobserve=function(){for(var t,e,i=0;i<this.tokens.length;i++)e=this.tokens[i],(t=this.objectPath[i])&&this.set(!1,e,t,this);l(this.target)&&this.set(!1,this.key,this.target,this.callback)},f.prototype.getRootObject=function(t){var e,i;if(!t.$parent)return t;for(e=this.tokens.length?this.tokens[0].path:this.key.path,i=t;i.$parent&&void 0===i[e];)i=i.$parent;return i};var d=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};var v=/[^\s']+|'([^']|'[^\s])*'|"([^"]|"[^\s])*"/g,y=/\s+/,m=function(){function a(t,e,i,n,r,s,o){d(this,a),this.view=t,this.el=e,this.type=i,this.keypath=n,this.binder=r,this.args=s,this.formatters=o,this.formatterObservers={},this.model=void 0}return a.prototype.observe=function(t,e){return new f(t,e,this)},a.prototype.parseTarget=function(){if(this.keypath){var t=p(this.keypath);if(0===t.type)this.value=t.value;else{if(1!==t.type)throw new Error("Unknown type in token",t);this.observer=this.observe(this.view.models,this.keypath),this.model=this.observer.target}}else this.value=void 0},a.prototype.getIterationAlias=function(t){return"%"+t+"%"},a.prototype.parseFormatterArguments=function(t,s){var o=this;return t.map(p).map(function(t,e){var i=t.type,n=t.value;if(0===i)return n;if(1===i){o.formatterObservers[s]||(o.formatterObservers[s]={});var r=o.formatterObservers[s][e];return r||(r=o.observe(o.view.models,n),o.formatterObservers[s][e]=r),r.value()}throw new Error("Unknown type",i,n)})},a.prototype.formattedValue=function(t){var a=this;return this.formatters.reduce(function(t,e,i){var n=e.match(v),r=n.shift(),s=a.view.options.formatters[r],o=a.parseFormatterArguments(n,i);return s&&s.read instanceof Function?t=s.read.apply(s,[t].concat(o)):s instanceof Function&&(t=s.apply(void 0,[t].concat(o))),t},t)},a.prototype.eventHandler=function(e){var i=this,n=i.view.options.handler;return function(t){n.call(e,this,t,i)}},a.prototype.set=function(t){t=t instanceof Function&&!this.binder.function?this.formattedValue(t.call(this.model)):this.formattedValue(t);var e=this.binder.routine||this.binder;e instanceof Function&&e.call(this,this.el,t)},a.prototype.sync=function(){this.observer?(this.model=this.observer.target,this.set(this.observer.value())):this.set(this.value)},a.prototype.publish=function(){var a=this;if(this.observer){var t=this.formatters.reduceRight(function(t,e,i){var n=e.split(y),r=n.shift(),s=a.view.options.formatters[r],o=a.parseFormatterArguments(n,i);return s&&s.publish&&(t=s.publish.apply(s,[t].concat(o))),t},this.getValue(this.el));this.observer.setValue(t)}},a.prototype.bind=function(){this.parseTarget(),this.binder.hasOwnProperty("bind")&&this.binder.bind.call(this,this.el),this.view.options.preloadData&&this.sync()},a.prototype.unbind=function(){var i=this;this.binder.unbind&&this.binder.unbind.call(this,this.el),this.observer&&this.observer.unobserve(),Object.keys(this.formatterObservers).forEach(function(t){var e=i.formatterObservers[t];Object.keys(e).forEach(function(t){e[t].unobserve()})}),this.formatterObservers={}},a.prototype.update=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.observer&&(this.model=this.observer.target),this.binder.update&&this.binder.update.call(this,t)},a.prototype.getValue=function(t){return this.binder&&this.binder.getValue?this.binder.getValue.call(this,t):(i=[],"checkbox"===(e=t).type?e.checked:"select-multiple"===e.type?(e.options.forEach(function(t){t.selected&&i.push(t.value)}),i):e.value);var e,i},a}(),k=function(l){function f(t,e,i){d(this,f);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,l.call(this,t,e,i,null,null,null,null));n.view=t,n.el=e,n.type=i,n.component=t.options.components[n.type],n.static={},n.observers={},n.upstreamObservers={};for(var r=b._fullPrefix,s=0,o=e.attributes.length;s<o;s++){var a=e.attributes[s];if(0!==a.name.indexOf(r)){var h=n.camelCase(a.name),c=p(a.value),u=n.component.static;if(u&&-1<u.indexOf(h))n.static[h]=a.value;else if(0===c.type)n.static[h]=c.value;else{if(1!==c.type)throw new Error("can't parse component attribute",a,c);n.observers[h]=a.value}}}return n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(f,l),f.prototype.sync=function(){},f.prototype.update=function(){},f.prototype.publish=function(){},f.prototype.locals=function(){var e=this,i={};return Object.keys(this.static).forEach(function(t){i[t]=e.static[t]}),Object.keys(this.observers).forEach(function(t){i[t]=e.observers[t].value()}),i},f.prototype.camelCase=function(t){return t.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()})},f.prototype.bind=function(){var r=this,i={};if(this.bound||(Object.keys(this.observers).forEach(function(t){var e=r.observers[t];r.observers[t]=r.observe(r.view.models,e,function(t){return function(){r.componentView.models[t]=r.observers[t].value()}}.call(r,t))}),this.bound=!0),this.componentView)this.componentView.bind();else{this.el.innerHTML=this.component.template.call(this);var t=this.component.initialize.call(this,this.el,this.locals());this.el._bound=!0,o.forEach(function(e){i[e]={},r.component[e]&&Object.keys(r.component[e]).forEach(function(t){i[e][t]=r.component[e][t]}),Object.keys(r.view.options[e]).forEach(function(t){i[e][t]&&(i[e][t]=r.view[e][t])})}),s.forEach(function(t){null!=r.component[t]?i[t]=r.component[t]:i[t]=r.view[t]}),this.componentView=b.bind(Array.prototype.slice.call(this.el.childNodes),t,i),Object.keys(this.observers).forEach(function(t){var e=r.observers[t],i=r.componentView.models,n=r.observe(i,t,function(t,e){return function(){e.setValue(r.componentView.models[t])}}.call(r,t,e));r.upstreamObservers[t]=n})}},f.prototype.unbind=function(){var e=this;Object.keys(this.upstreamObservers).forEach(function(t){e.upstreamObservers[t].unobserve()}),Object.keys(this.observers).forEach(function(t){e.observers[t].unobserve()}),this.componentView&&this.componentView.unbind.call(this)},f}(m),g={routine:function(t,e){t.data=null!=e?e:""}},O=/((?:'[^']*')*(?:(?:[^\|']*(?:'[^']*')+[^\|']*)+|[^\|]+))|^$/g,w=function t(e,i){var n=!1;if(3===i.nodeType){var r=c(i.data,b.templateDelimiters);if(r){for(var s=0;s<r.length;s++){var o=r[s],a=document.createTextNode(o.value);i.parentNode.insertBefore(a,i),1===o.type&&e.buildBinding(a,null,o.value,g,null)}i.parentNode.removeChild(i)}n=!0}else 1===i.nodeType&&(n=e.traverse(i));if(!n)for(var h=0;h<i.childNodes.length;h++)t(e,i.childNodes[h])},E=function(t,e){var i=t.binder&&t.binder.priority||0;return(e.binder&&e.binder.priority||0)-i},j=function(t){return t.trim()},_=function(){function n(t,e,i){d(this,n),t.jquery||t instanceof Array?this.els=t:this.els=[t],this.models=e,this.options=i,this.build()}return n.prototype.buildBinding=function(t,e,i,n,r){var s=i.match(O).map(j),o=s.shift();this.bindings.push(new m(this,t,e,o,n,r,s))},n.prototype.build=function(){this.bindings=[];var t,e=this.els,i=void 0;for(i=0,t=e.length;i<t;i++)w(this,e[i]);this.bindings.sort(E)},n.prototype.traverse=function(t){for(var e,i,n,r,s=b._fullPrefix,o="SCRIPT"===t.nodeName||"STYLE"===t.nodeName,a=t.attributes,h=[],c=this.options.starBinders,u=0,l=a.length;u<l;u++){var f=a[u];if(0===f.name.indexOf(s)){if(e=f.name.slice(s.length),r=[],!(i=this.options.binders[e]))for(var p=0;p<c.length;p++)if(n=c[p],e.slice(0,n.length-1)===n.slice(0,-1)){i=this.options.binders[n],r.push(e.slice(n.length-1));break}if(i||(i=b.fallbackBinder),i.block)return this.buildBinding(t,e,f.value,i,r),t.removeAttribute(f.name),!0;h.push({attr:f,binder:i,type:e,args:r})}}for(var d=0;d<h.length;d++){var v=h[d];this.buildBinding(t,v.type,v.attr.value,v.binder,v.args),t.removeAttribute(v.attr.name)}return o||(e=t.nodeName.toLowerCase(),this.options.components[e]&&!t._bound&&(this.bindings.push(new k(this,t,e)),o=!0)),o},n.prototype.bind=function(){this.bindings.forEach(function(t){t.bind()})},n.prototype.unbind=function(){this.bindings.forEach(function(t){t.unbind()})},n.prototype.sync=function(){this.bindings.forEach(function(t){t.sync()})},n.prototype.publish=function(){this.bindings.forEach(function(t){t.binder&&t.binder.publishes&&t.publish()})},n.prototype.update=function(){var e=this,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};Object.keys(i).forEach(function(t){e.models[t]=i[t]}),this.bindings.forEach(function(t){t.update&&t.update(i)})},n}(),x=["push","pop","shift","unshift","sort","reverse","splice"],t={counter:0,weakmap:{},weakReference:function(t){if(!t.hasOwnProperty("__rv")){var e=this.counter++;Object.defineProperty(t,"__rv",{value:e})}return this.weakmap[t.__rv]||(this.weakmap[t.__rv]={callbacks:{}}),this.weakmap[t.__rv]},cleanupWeakReference:function(t,e){Object.keys(t.callbacks).length||t.pointers&&Object.keys(t.pointers).length||delete this.weakmap[e]},stubFunction:function(r,t){var s=r[t],o=this.weakReference(r),a=this.weakmap;r[t]=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=s.apply(r,e);return Object.keys(o.pointers).forEach(function(t){var e=o.pointers[t];a[t]&&a[t].callbacks[e]instanceof Array&&a[t].callbacks[e].forEach(function(t){t.sync()})}),n}},observeMutations:function(e,t,i){var n=this;if(e instanceof Array){var r=this.weakReference(e);r.pointers||(r.pointers={},x.forEach(function(t){n.stubFunction(e,t)})),r.pointers[t]||(r.pointers[t]=[]),-1===r.pointers[t].indexOf(i)&&r.pointers[t].push(i)}},unobserveMutations:function(t,e,i){if(t instanceof Array&&null!=t.__rv){var n=this.weakmap[t.__rv];if(n){var r=n.pointers[e];if(r){var s=r.indexOf(i);-1<s&&r.splice(s,1),r.length||delete n.pointers[e],this.cleanupWeakReference(n,t.__rv)}}}},observe:function(n,r,t){var s,o=this,e=this.weakReference(n).callbacks;if(!e[r]){e[r]=[];var i=Object.getOwnPropertyDescriptor(n,r);i&&(i.get||i.set||!i.configurable)||(s=n[r],Object.defineProperty(n,r,{enumerable:!0,get:function(){return s},set:function(t){if(t!==s){o.unobserveMutations(s,n.__rv,r),s=t;var e=o.weakmap[n.__rv];if(e){var i=e.callbacks[r];i&&i.forEach(function(t){t.sync()}),o.observeMutations(t,n.__rv,r)}}}}))}-1===e[r].indexOf(t)&&e[r].push(t),this.observeMutations(n[r],n.__rv,r)},unobserve:function(t,e,i){var n=this.weakmap[t.__rv];if(n){var r=n.callbacks[e];if(r){var s=r.indexOf(i);-1<s&&(r.splice(s,1),r.length||(delete n.callbacks[e],this.unobserveMutations(t[e],t.__rv,e))),this.cleanupWeakReference(n,t.__rv)}}},get:function(t,e){return t[e]},set:function(t,e,i){t[e]=i}},N=function(t){return null!=t?t.toString():void 0};function A(t,e,i){var n=t.el.cloneNode(!0),r=new _(n,e,t.view.options);return r.bind(),t.marker.parentNode.insertBefore(n,i),r}var e={"on-*":{function:!0,priority:1e3,unbind:function(t){this.handler&&t.removeEventListener(this.args[0],this.handler)},routine:function(t,e){this.handler&&t.removeEventListener(this.args[0],this.handler),this.handler=this.eventHandler(e),t.addEventListener(this.args[0],this.handler)}},"each-*":{block:!0,priority:4e3,bind:function(t){this.marker?this.iterated.forEach(function(t){t.bind()}):(this.marker=document.createComment(" tinybind: "+this.type+" "),this.iterated=[],t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t))},unbind:function(t){this.iterated&&this.iterated.forEach(function(t){t.unbind()})},routine:function(t,e){var h=this,c=this.args[0];if(e=e||[],!Array.isArray(e))throw new Error("each-"+c+" needs an array to iterate over, but it is",e);var u=t.getAttribute("index-property")||this.getIterationAlias(c);e.forEach(function(t,e){var i={$parent:h.view.models};i[u]=e,i[c]=t;var n=h.iterated[e];if(n)if(n.models[c]!==t){for(var r=void 0,s=void 0,o=e+1;o<h.iterated.length;o++)if((s=h.iterated[o]).models[c]===t){r=o;break}void 0!==r?(h.iterated.splice(r,1),h.marker.parentNode.insertBefore(s.els[0],n.els[0]),s.models[u]=e):s=A(h,i,n.els[0]),h.iterated.splice(e,0,s)}else n.models[u]=e;else{var a=h.marker;h.iterated.length&&(a=h.iterated[h.iterated.length-1].els[0]),n=A(h,i,a.nextSibling),h.iterated.push(n)}}),this.iterated.length>e.length&&function(t,e){for(var i=0;i<t;i++)e()}(this.iterated.length-e.length,function(){var t=h.iterated.pop();t.unbind(),h.marker.parentNode.removeChild(t.els[0])}),"OPTION"===t.nodeName&&this.view.bindings.forEach(function(t){t.el===h.marker.parentNode&&"value"===t.type&&t.sync()})},update:function(e){var i=this,n={};Object.keys(e).forEach(function(t){t!==i.args[0]&&(n[t]=e[t])}),this.iterated.forEach(function(t){t.update(n)})}},"class-*":function(t,e){var i=" "+t.className+" ";e!==-1<i.indexOf(" "+this.args[0]+" ")&&(t.className=e?t.className+" "+this.args[0]:i.replace(" "+this.args[0]+" "," ").trim())},text:function(t,e){t.textContent=null!=e?e:""},html:function(t,e){t.innerHTML=null!=e?e:""},show:function(t,e){t.style.display=e?"":"none"},hide:function(t,e){t.style.display=e?"none":""},enabled:function(t,e){t.disabled=!e},disabled:function(t,e){t.disabled=!!e},checked:{publishes:!0,priority:2e3,bind:function(t){var e=this;this.callback||(this.callback=function(){e.publish()}),t.addEventListener("change",this.callback)},unbind:function(t){t.removeEventListener("change",this.callback)},routine:function(t,e){"radio"===t.type?t.checked=N(t.value)===N(e):t.checked=!!e}},value:{publishes:!0,priority:3e3,bind:function(t){if(this.isRadio="INPUT"===t.tagName&&"radio"===t.type,!this.isRadio){this.event=t.getAttribute("event-name")||("SELECT"===t.tagName?"change":"input");var e=this;this.callback||(this.callback=function(){e.publish()}),t.addEventListener(this.event,this.callback)}},unbind:function(t){this.isRadio||t.removeEventListener(this.event,this.callback)},routine:function(t,e){if(this.isRadio)t.setAttribute("value",e);else if("select-multiple"===t.type){if(e instanceof Array)for(var i=0;i<t.length;i++){var n=t[i];n.selected=-1<e.indexOf(n.value)}}else N(e)!==N(t.value)&&(t.value=null!=e?e:"")}},if:{block:!0,priority:4e3,bind:function(t){this.marker?!1===this.bound&&this.nested&&this.nested.bind():(this.marker=document.createComment(" tinybind: "+this.type+" "+this.keypath+" "),this.attached=!1,t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)),this.bound=!0},unbind:function(){this.nested&&(this.nested.unbind(),this.bound=!1)},routine:function(t,e){(e=!!e)!==this.attached&&(e?(this.nested||(this.nested=new _(t,this.view.models,this.view.options),this.nested.bind()),this.marker.parentNode.insertBefore(t,this.marker.nextSibling),this.attached=!0):(t.parentNode.removeChild(t),this.attached=!1))},update:function(t){this.nested&&this.nested.update(t)}}};return b.binders=e,b.adapters["."]=t,b.bind=function(t,e,i){var n={};e=e||{},i=i||{},o.forEach(function(e){n[e]=Object.create(null),i[e]&&Object.keys(i[e]).forEach(function(t){n[e][t]=i[e][t]}),Object.keys(b[e]).forEach(function(t){n[e][t]||(n[e][t]=b[e][t])})}),s.forEach(function(t){var e=i[t];n[t]=null!=e?e:b[t]}),n.starBinders=Object.keys(n.binders).filter(function(t){return 0<t.indexOf("*")}),f.updateOptions(n);var r=new _(t,e,n);return r.bind(),r},b.init=function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};e||(e=document.createElement("div")),t=b.components[t],e.innerHTML=t.template.call(b,e);var n=t.initialize.call(b,e,i),r=b.bind(e,n);return r.bind(),r},b.formatters.negate=b.formatters.not=function(t){return!t},b});
//# sourceMappingURL=tinybind.min.js.map
